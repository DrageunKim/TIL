# [3ì›” 2ì¼]

MVVM ì•„í‚¤í…ì³ë¥¼ ê³µë¶€í•˜ë‹¤ë³´ë©´ RxSwift ë˜ëŠ” Combineì— ëŒ€í•œ ê¸€ì„ ë§ì´ ë³¼ ìˆ˜ ìˆì—ˆëŠ”ë°
Combineì€ SwiftUIì™€  ì˜ì–´ìš¸ë¦°ë‹¤ê³  í•˜ì—¬ RxSwiftë¥¼ ë¨¼ì € ê³µë¶€í•´ë³´ê²Œ ë˜ì—ˆë‹¤.

ì˜¤ëŠ˜ì´ ì²˜ìŒ RxSwiftë¥¼ ë‹¤ë¤„ë³´ëŠ”ê±°ë¼ ê°œë…ì ìœ¼ë¡œ ë§ì´ ë¶€ì¡±í•˜ë‹¤ë³´ë‹ˆ ì˜ëª»ëœ ì •ë³´ê°€ ìˆì„ ìˆ˜ ë„ ìˆì„ë“¯!
ì ì°¨ì ì°¨ ê°œë…ì„ ë‹¤ì§€ê³  ì˜ëª»ëœ ê°œë…ì„ ê³ ì³ë‚˜ê°€ë³´ë„ë¡ í•´ì•¼ê² ë‹¤!

***

### 1. RxSwift ê¸°ì´ˆ

> ê³µì‹í™ˆí˜ì´ì§€ : https://reactivex.io/
>
> ì°¸ê³ ìë£Œ : https://github.com/iamchiwon/RxSwift_In_4_Hours
> ì •ë§ ê¸°ì´ˆë¥¼ ì•Œì•„ê°€ëŠ”ë°ëŠ” ì´ë§Œí•œ ê°•ì˜ìë£Œê°€ ì—†ì„ë“¯...! ê·¸ê²ƒë„ ë¬´ë£Œ! ğŸ‘

- Observable Streamsì„ ì´ìš©í•˜ì—¬ ë¹„ë™ê¸° í”„ë¡œê·¸ë˜ë°ì„ ê°€ëŠ¥í•˜ê²Œ í•´ì£¼ëŠ” API

- ê¸°ë³¸ê°œë…

  ê¸°ë³¸ì ìœ¼ë¡œ í™ˆí˜ì´ì§€ì— ì„¤ëª…ì´ ì˜ë‚˜ì™€ìˆìŒ
  ê·¸ë¦¼ìœ¼ë¡œ ë˜ì–´ìˆëŠ” marble diagramì„ í†µí•´ ê¸°ëŠ¥ ì„¤ëª…ì„ ì´í•´í•˜ê¸° ì‰½ê²Œë„ ì˜í•´ë†“ìŒ

  - Observable : ì „ì²´ì ì¸ ë¼ˆëŒ€ë¡œ êµ¬ë…ì€ 1 - 1 (ê°œì¸ ê³¼ì™¸)
  - Operators : ë¼ˆëŒ€ì•ˆì—ì„œ ì§„í–‰ë  ì‘ì—… (ë°ì´í„° ì²˜ë¦¬ ê³¼ì •)
  - Single : ëª°ë¼ë„ ë¨...ğŸ¥² ë‚˜ì¤‘ì— ì°¾ì•„ë´ì•¼ì§€...!
  - Subject : Observableê³¼ ë¹„ìŠ·í•œ ì „ì²´ì ì¸ ë¼ˆëŒ€ ëŠë‚Œì´ì§€ë§Œ êµ¬ë…ì´ 1 - N (ê·¸ë£¹ ê³¼ì™¸)
  - Scheduler : Thread ì„¤ì • (Main & Global)
  - Disposable : **ë¦¬ì†ŒìŠ¤ë¥¼ í•´ì œí•˜ê³  ì´ë²¤íŠ¸ êµ¬ë…ì„ ì¤‘ì§€**



***

- #### DispatchQueue & RxSwift ì°¨ì´ì 

  - DispatchQueue ì˜ˆì œì½”ë“œ

    ```swift
    DispatchQueue.global().async {
        let image = self.loadImage(from: self.IMAGE_URL)
        DispatchQueue.main.async {
            self.imageView.image = image
        }
    }
    ```

  - RxSwift ì˜ˆì œì½”ë“œ

    ```swift
    var disposeBag = DisposeBag()
    
    // Observable ìƒì„± í›„ image ë°ì´í„°ë¥¼ ë‹´ì•„ì„œ ì „ë‹¬
    func rxswiftLoadImage(from imageUrl: String) -> Observable<UIImage?> {
      return Observable.create { seal in
          asyncLoadImage(from: imageUrl) { image in
              seal.onNext(image)
              seal.onCompleted()
          }
          return Disposables.create()
      }
    }
    
    /* 
    Obsevableì— ë‹´ê¸´ image ë°ì´í„°ë¥¼ observeOnì„ í†µí•´ Main Threadì—ì„œ ì‘ì—…ì„ ì§€ì‹œ
    subscribeë¥¼ í†µí•´ image ë°ì´í„°ë¥¼ ì–´ë–»ê²Œ ì‚¬ìš©í• ì§€ ì„¤ì •, ì—ëŸ¬ ì„¤ì •, ì™„ë£Œ í›„ ì‘ì—… ì„¤ì •
    disposableì—ì„œ ìˆ˜í–‰ë˜ëŠ” ì‘ì—…ì´ ì™„ë£Œë˜ë©´ ë¦¬ì†ŒìŠ¤ í•´ì œë  ìˆ˜ ìˆë„ë¡ disposeBagì— ë‹´ìŒ */
    @IBAction func onLoadImage(_ sender: Any) {
      imageView.image = nil
    
      rxswiftLoadImage(from: LARGER_IMAGE_URL)
          .observeOn(MainScheduler.instance)
          .subscribe({ result in
              switch result {
              case let .next(image):
                  self.imageView.image = image
    
              case let .error(err):
                  print(err.localizedDescription)
    
              case .completed:
                  break
              }
          })
      		.disposed(by: disposeBag)
    }
    
    /*
    disposableì´ disposeBagì— ë‹´ê²¨ì ¸ìˆê¸°ì— ì·¨ì†Œë²„íŠ¼ì„ ëˆŒë €ì„ ê²½ìš°ì—
    disposeBagì„ ì´ˆê¸°í™”í•˜ë©´ disposableì—ì„œ ì§„í–‰ ì¤‘ì¸ ì‘ì—…ë„ ëª¨ë‘ ì •ì§€ */
    @IBAction func onCancel(_ sender: Any) {
        disposeBag = DisposeBag()
    }
    ```

    - ì§€ê¸ˆ ë³´ê¸°ì—ëŠ” RxSwiftê°€ ë” ë¹„íš¨ìœ¨ì ì´ì—¬ ë³´ì´ë‚˜, ì ì  ì½”ë“œë¥¼ ê°„ì†Œí™”í•˜ëŠ” ë°©ë²•ì€ ì•„ë˜ì— ì‘ì„±í•˜ì˜€ìŒ
    - ì¶”ê°€ë¡œ, ë¹„ë™ê¸° í”„ë¡œê·¸ë˜ë°ì˜ ì‘ì—…ì´ ì—¬ëŸ¬ê°œê°€ ë  ê²½ìš° í›¨ì”¬ í¸í•˜ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŒ



***

- #### Observable ìƒì„± & Operation ì‚¬ìš©

  ìœ„ ì˜ˆì œì½”ë“œì—ì„œ Observable.createë¥¼ í†µí•´ ë°ì´í„°ë¥¼ ë§Œë“¤ì–´ì¤€ ë‹¤ìŒ subscribeë¥¼  í†µí•´ ë°ì´í„°ë¥¼ ë‹¤ë£¸
  Observable.create ì™¸ì—ë„ Observableì„ ìƒì„±í•˜ëŠ” Operationì´ ìˆì–´ì„œ ì•„ë˜ì—ì„œ Just, From í™•ì¸

  ëŒ€í‘œì ì¸ Operation ëª‡ê°€ì§€ë§Œ ê°€ì ¸ì™”ê³ , êµ‰ì¥íˆ ë§ì€ Operationì´ ìˆìœ¼ë‹ˆ í™ˆí˜ì´ì§€ì—ì„œ í™•ì¸í•´ë³´ì!

  - Just - ë°ì´í„°ë¥¼ ì§ì ‘ ë„£ì–´ì„œ ì‚¬ìš©í•˜ëŠ” ë°©ë²•

    ```swift
    Observable.just("Hello World")
      .subscribe(onNext: { str in
          print(str)
      })
      .disposed(by: disposeBag)
    // Hello World
    
    Observable.just(["Hello", "World"])
      .subscribe(onNext: { arr in
          print(arr)
      })
      .disposed(by: disposeBag)
    // ["Hello", "World"]
    ```

  - From - ë°ì´í„°ë¥¼ ë°°ì—´ì—ì„œ í•˜ë‚˜ì”© ë¹¼ì™€ì„œ ì‚¬ìš©í•˜ëŠ” ë°©ë²•

    ```swift
    Observable.from(["RxSwift", "In", "4", "Hours"])
      .subscribe(onNext: { str in
          print(str)
      })
      .disposed(by: disposeBag)
    // RxSwift
    // In
    // 4
    // Hours
    ```

  - Map - ê³ ì°¨í•¨ìˆ˜ì˜ Mapê³¼ ë™ì¼

    ```swift
    Observable.just("Hello")
      .map { str in "\(str) RxSwift" }
      .subscribe(onNext: { str in
          print(str)
      })
      .disposed(by: disposeBag)
    ```

  - Filter - ê³ ì°¨í•¨ìˆ˜ì˜ Filterì™€ ë™ì¼

    ```swift
    Observable.from([1, 2, 3, 4, 5, 6, 7, 8, 9, 10])
      .filter { $0 % 2 == 0 }
      .subscribe(onNext: { n in
          print(n)
      })
      .disposed(by: disposeBag)
    ```

  - ì „ì²´ì ìœ¼ë¡œ ì‘ìš©í•œ ì˜ˆì œì½”ë“œ

    ```swift
    Observable.just("800x600")
      .map { $0.replacingOccurrences(of: "x", with: "/") }
      .map { "https://picsum.photos/\($0)/?random" }
      .map { URL(string: $0) }
      .filter { $0 != nil }
      .map { $0! } //ìœ„ Filterì—ì„œ ì˜µì…”ë„ì„ í™•ì¸í–ˆê¸°ì— ê°•ì œì–¸ë˜í•‘ (ê°„ì†Œí™” ê°€ëŠ¥, ì•„ë˜ ì†Œê°œ)
      .map { try Data(contentsOf: $0) }
      .map { UIImage(data: $0) }
      .subscribe(onNext: { image in
          self.imageView.image = image
      })
      .disposed(by: disposeBag)
    ```



***

- #### Subscribe ì‚¬ìš©

  ëŒ€í‘œì ìœ¼ë¡œ ìì£¼ ì‚¬ìš©ë˜ëŠ” Subscribe ì‚¬ìš©ë²•ì„ ì •ë¦¬í•´ë³´ì•˜ë‹¤

  - Next / Error / Completed - **ëŒ€í‘œì ì¸ ì‚¬ìš©ë²• (ì„¸ê°œì˜ ë‹¨ìœ„ê°€ í•œë¬¶ìŒ)**

    ```swift
    Observable.from(["RxSwift", "In", "4", "Hours"])
      .subscribe({ event in
          switch event {
          case .next(let str):
              print("next: \(str)")
          case .error(let error):
              print(error.localizedDescription)
          case .completed:
              print("completed")
          }
      })
      .disposed(by: disposeBag)
    // next: RxSwift
    // next: In
    // next: 4
    // next: Hours
    // completed
    ```

  - Next / Error / Completed / Disposed - **ì›í•˜ëŠ” ë‹¨ìœ„ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŒ**

    ```swift
    Observable.from(["RxSwift", "In", "4", "Hours"])
      .subscribe(onNext: { str in // ë°ì´í„° ì²˜ë¦¬ í›„
          print(str)
      }, onError: { error in
          print(error.localizedDescription) // ì—ëŸ¬ ë°œìƒ í›„
      }, onCompleted: {
          print("completed") // ì‘ì—… ì™„ë£Œ í›„
      }, onDisposed: {
          print("disposed") // ë¦¬ì†ŒìŠ¤ í•´ì œëœ í›„ 
      })
      .disposed(by: disposeBag)
    ```



***

- #### Scheduler ì‚¬ìš©

  - observeOn - ì…‹íŒ…í•œ ìˆœê°„ë¶€í„° ì•„ë˜ ì½”ë“œëŠ” ëª¨ë‘ í•´ë‹¹ Threadë¡œ ì²˜ë¦¬

  ```swift
  Observable.just("800x600")
    .observeOn(ConcurrentDispatchQueueScheduler(qos: .default)) // GLOBAL
    .map { $0.replacingOccurrences(of: "x", with: "/") } // GLOBAL
    .map { "https://picsum.photos/\($0)/?random" } // GLOBAL
    .map { URL(string: $0) } // GLOBAL
    .filter { $0 != nil } // GLOBAL
    .map { $0! } // GLOBAL
    .map { try Data(contentsOf: $0) } // GLOBAL
    .map { UIImage(data: $0) } // GLOBAL
    .observeOn(MainScheduler.instance // MAIN
    .subscribe(onNext: { image in // MAIN
        self.imageView.image = image // MAIN
    })
    .disposed(by: disposeBag)
  ```

  - subscribeOn - ì•„ë¬´ê³³ì— ìˆì–´ë„ ì „ì²´ì ì¸ ì‘ì—…ì´ ì„¸íŒ…ëœ Threadë¡œ ì²˜ë¦¬

  ```swift
  Observable.just("800x600")
    .map { $0.replacingOccurrences(of: "x", with: "/") }
    .map { "https://picsum.photos/\($0)/?random" }
    .subscribeOn(ConcurrentDispatchQueueScheduler(qos: .default)) // ìœ„ì¹˜ììœ 
    .map { URL(string: $0) }
    .filter { $0 != nil }
    .map { $0! }
    .map { try Data(contentsOf: $0) }
    .map { UIImage(data: $0) }
    .observeOn(MainScheduler.instance) // View ê·¸ë¦¬ëŠ” ì‘ì—…ì€ ë°˜ë“œì‹œ Main
    .subscribe(onNext: { image in
        self.imageView.image = image
    })
    .disposed(by: disposeBag)
  ```

  

***

- #### ì½”ë“œ ê°„ì†Œí™” (RxCocoaë„ í•¨ê»˜ ì‚¬ìš©)

  - Thread ì„¤ì • - observeOn & subscribeOn   â¡ï¸   **rx**

    ```swift
    // idFieldë¥¼ ë¹„ë™ê¸°ë¡œ ì²˜ë¦¬í•˜ê² ë‹¤ -> idField.rx
    idField.rx.text
    	.subscribe(onNext: { str in 
      	print(str)
      })
    ```

  - unwrapping  - filter & map   â¡ï¸   **orEmpty**

    ```swift
    // ê¸°ì¡´
    idField.rx.text
    	.filter { $0 != nil }
    	.map { $0! }
    
    // ë³€ê²½
    idField.rx.text.orEmpty
    ```

  

***

- #### RxSwift ì‘ìš©

  - idField & pwField ìœ íš¨ì„± í™•ì¸í•˜ì—¬ ë¡œê·¸ì¸

    ```swift
    /* 1ì°¨ */
    idField.rx.text.orEmpty
    	.map(checkEmailValid)
    	.subscribe(onNext: { bool in
     		self.idValidView.isHidden = bool
      })
    	.disposed(by: disposeBag)
    
    pwField.rx.text.orEmpty
    	.map(checkPasswordValid)
    	.subscribe(onNext: { bool in
     		self.pwValidView.isHidden = bool
      })
    	.disposed(by: disposeBag)
    
    Observable.comineLatest(
      idField.rx.text.orEmpty.map(checkEmailValid)
    	pwField.rx.text.orEmpty.map(checkPasswordValid)
      resultSelector: { s1, s2 in s1 && s2 }
    )
    	.subscribe(onNext: { bool in
      	self.loginButton.isEnabled = bool                   
    	})
    	.disposed(by: disposeBag)
    
    /* 2ì°¨ */
    let idInputOb: Observable<String> = idField.rx.text.orEmpty.asObservable()
    //.asObservable()ì„ ì‚¬ìš©í•˜ì—¬ Observableë¡œ íƒ€ì…ìºìŠ¤íŒ…
    // rxë‹¨ì—ì„œ Reactiveë¡œ íƒ€ì…ìºìŠ¤íŒ…, textë‹¨ì—ì„œ ControlPropertyë¡œ íƒ€ì…ìºìŠ¤íŒ… ë˜ì–´ìˆìŒ
    let idValidOb = idInputOb.map(checkEmailValid)
    
    let pwInputOb: Observable<String> = pwField.rx.text.orEmpty.asObservable()
    let pwValidOb = pwInputOb.map(checkPasswordValid)
    
    idValidOb.subscribe(onNext: { bool in
      self.idValidView.isHidden = bool
    }).disposed(by: disposeBag)
    
    pwValidOb.subscribe(onNext: { bool in
      self.pwValidView.isHidden = bool
    }).disposed(by: disposeBag)
    
    Observable.combineLatest(
      idValidOb, pwValidOb,
      resultSelector: { $0 && $1 }
    )
      .subscribe(onNext: { bool in self.loginButton.isEnabled = bool })
      .disposed(by: disposeBag)
    ```



***

- #### Subject

  - ì¢…ë¥˜

    - PublishSubject - ê¸°ë³¸ Subject
    - BehaviorSubject - ê¸°ë³¸ê°’ì„ ê°€ì§€ê³  ì²˜ìŒ êµ¬ë…í•  ë•Œë§Œ ê¸°ë³¸ê°’ì„ ì „ë‹¬í•´ì£¼ëŠ” Subject
    - ReplaySubject - ì´ì „ì— ìˆë˜ ê°’ì„ êµ¬ë…í•  ë•Œ ëª¨ë‘ ì „ë‹¬í•´ì£¼ëŠ” Subject
    - AsyncSubject - ë§ˆì§€ë§‰ ê°’ì„ Completed ë˜ê¸° ì§ì „ì— ì „ë‹¬í•´ì£¼ëŠ” Subject

  - Subjectë¥¼ í™œìš©í•˜ì—¬ ì½”ë“œë¥¼ ë” ê°„ì†Œí™” í•  ìˆ˜ ìˆìŒ

    ```swift
    let idInputText: BehaviorSubject<String> = BehaviorSubject(value: String())
    let idValid: BehaviorSubject<Bool> = BehaviorSubject(value: false)
    let pwInputText: BehaviorSubject<String> = BehaviorSubject(value: String())
    let pwValid: BehaviorSubject<Bool> = BehaviorSubject(value: false)
    
    /* ê¸°ë³¸ */
    let idInputOb: Observable<String> = idField.rx.text.orEmpty.asObservable()
    let idValidOb = idInputOb.map(checkEmailValid)
    idValidOb.subscribe(onNext: { bool in 
    	self.idValid.onNext(bool)
    })
    
    /* bind ì‚¬ìš© */
    let idInputOb: Observable<String> = idField.rx.text.orEmpty.asObservable()
    let idValidOb = idInputOb.map(checkEmailValid)
    idValidOb.bind(to: idValid) // idValidë¡œ idValidObì˜ ê°’ì„ ì „ë‹¬
    
    /* bind 1ì°¨ì •ë¦¬ */
    let idInputOb: Observable<String> = idField.rx.text.orEmpty.asObservable()
    idInputOb.map(checkEmailValid)
    	.bind(to: idValid)
    	.disposed(by: disposeBag)
    
    /* bind 2ì°¨ì •ë¦¬ */
    idField.rx.text.orEmpty
      .bind(to: idInputText)
      .disposed(by: disposeBag)
    
    idInputText
      .map(checkEmailValid)
      .bind(to: idValid)
      .disposed(by: disposeBag)
    
    /* ìµœì¢… - Input & Output ì •ë¦¬ */
    private func bindInput() {
        idField.rx.text.orEmpty
            .bind(to: idInputText)
            .disposed(by: disposeBag)
    
        idInputText
            .map(checkEmailValid)
            .bind(to: idValid)
            .disposed(by: disposeBag)
    
        pwField.rx.text.orEmpty
            .bind(to: pwInputText)
            .disposed(by: disposeBag)
    
        pwInputText
            .map(checkPasswordValid)
            .bind(to: pwValid)
            .disposed(by: disposeBag)
    }
    
    private func bindOutput() {
        idValid.subscribe { bool in self.idValidView.isHidden = bool }
            .disposed(by: disposeBag)
        pwValid.subscribe { bool in self.pwValidView.isHidden = bool }
            .disposed(by: disposeBag)
    
        Observable.combineLatest(idValid, pwValid) { $0 && $1 }
            .subscribe { bool in self.loginButton.isEnabled = bool }
            .disposed(by: disposeBag)
    }
    ```

    